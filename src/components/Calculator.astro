---
// ROI Calculator Component - matches Duplifinance style
---

<section id="calculator" class="calculator-section">
  <div class="container">
    <div class="section-head reveal">
      <div>
        <div class="kicker">
          <i data-lucide="calculator" style="width:16px;height:16px"></i>
          <span data-i18n="calculator.kicker">ROI PREDICTOR</span>
        </div>
        <h3 data-i18n="calculator.title">Snapshot ROI Predictor</h3>
      </div>
      <p data-i18n="calculator.description">
        Uses verified snapshot data to project implied weekly, monthly, and yearly returns. Adjust the snapshot period and investment amount to see projections.
      </p>
    </div>

    <div class="calc-card reveal">
      <!-- Header Pills -->
      <div class="calc-header">
        <div class="calc-pills">
          <div class="calc-pill">
            <span class="pill-label" data-i18n="calculator.snapshotGain">Snapshot:</span>
            <span class="pill-value">+264.40%</span>
          </div>
          <div class="calc-pill">
            <span class="pill-label" data-i18n="calculator.maxDD">Max DD:</span>
            <span class="pill-value">5.46%</span>
          </div>
          <div class="calc-pill">
            <span class="pill-label" data-i18n="calculator.platform">Platform:</span>
            <span class="pill-value">MetaTrader 5</span>
          </div>
          <div class="calc-pill">
            <span class="pill-label" data-i18n="calculator.leverage">Leverage:</span>
            <span class="pill-value">1:500</span>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="calc-body">
        <div class="calc-controls">
          <!-- Investment Input -->
          <div class="calc-panel">
            <label for="calcPrincipal" data-i18n="calculator.investmentLabel">Your investment</label>
            <input id="calcPrincipal" type="number" min="0" step="10" placeholder="1000" value="1000" />
            <div class="calc-helper" data-i18n="calculator.investmentHelper">
              Currency toggle changes symbols only (no FX conversion).
            </div>

            <div class="calc-currency-row">
              <div>
                <div class="calc-label" data-i18n="calculator.currency">Currency</div>
                <div class="calc-value" id="calcCurLabel">EUR</div>
              </div>
              <button type="button" class="calc-toggle" id="calcCurToggle" data-currency="EUR" aria-label="Toggle currency">
                <span class="toggle-knob"></span>
                <span class="toggle-labels">
                  <span>EUR</span>
                  <span>USD</span>
                </span>
              </button>
            </div>
          </div>

          <!-- Period Slider -->
          <div class="calc-panel">
            <div class="calc-range-header">
              <span class="calc-label" data-i18n="calculator.periodLabel">Snapshot period (months)</span>
              <span class="calc-value"><span id="calcMonthsVal">6</span> <span data-i18n="calculator.months">mo</span></span>
            </div>
            <input id="calcMonthsRange" type="range" min="1" max="24" step="1" value="6" />
            <div class="calc-helper" data-i18n="calculator.periodHelper">
              Default is 6 months. Adjust based on actual snapshot duration for accurate projections.
            </div>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="calc-stats">
          <div class="calc-stat">
            <div class="stat-value" id="calcWkRoi">0.00%</div>
            <div class="stat-label" data-i18n="calculator.weeklyROI">Implied Weekly ROI</div>
            <div class="stat-detail" id="calcWkProfit"></div>
          </div>
          <div class="calc-stat">
            <div class="stat-value" id="calcMoRoi">0.00%</div>
            <div class="stat-label" data-i18n="calculator.monthlyROI">Implied Monthly ROI</div>
            <div class="stat-detail" id="calcMoProfit"></div>
          </div>
          <div class="calc-stat highlight">
            <div class="stat-value" id="calcYrRoi">0.00%</div>
            <div class="stat-label" data-i18n="calculator.yearlyROI">Implied Yearly ROI (CAGR)</div>
            <div class="stat-detail" id="calcYrProfit"></div>
          </div>
        </div>

        <!-- Summary Row -->
        <div class="calc-summary">
          <div class="summary-item">
            <div class="calc-label" data-i18n="calculator.fullPeriod">Snapshot result over full period</div>
            <div class="summary-value">
              <span id="calcFullEnd">€0.00</span>
              <span class="summary-sub" id="calcFullProfit">(profit €0.00)</span>
            </div>
          </div>
          <div class="summary-item">
            <div class="calc-label" data-i18n="calculator.maxDrawdown">Max drawdown (from peak)</div>
            <div class="summary-value">
              <span id="calcDdAmt">€0.00</span>
              <span class="summary-sub">@ 5.46%</span>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="calc-actions">
          <button type="button" class="btn btn-primary" id="calcSaveBtn">
            <i data-lucide="save" style="width:16px;height:16px"></i>
            <span data-i18n="calculator.save">Save inputs</span>
          </button>
          <button type="button" class="btn btn-outline" id="calcResetBtn">
            <i data-lucide="rotate-ccw" style="width:16px;height:16px"></i>
            <span data-i18n="calculator.reset">Reset</span>
          </button>
        </div>

        <!-- Disclaimer -->
        <div class="calc-disclaimer">
          <i data-lucide="alert-triangle" style="width:16px;height:16px"></i>
          <p data-i18n="calculator.disclaimer">
            These are projections derived from one snapshot. Real results can differ due to fees, slippage, spreads, copy delays, and changing market conditions. Past performance is not a guarantee.
          </p>
        </div>

        <!-- Expandable Details -->
        <details class="calc-details">
          <summary data-i18n="calculator.howItWorks">How the math works</summary>
          <div class="details-content">
            <p data-i18n="calculator.mathExplanation">
              We treat the snapshot gain (+264.40%) as the total growth factor over the selected period. From that we derive:
            </p>
            <ul>
              <li data-i18n="calculator.mathMonthly">Monthly factor: totalFactor^(1/months)</li>
              <li data-i18n="calculator.mathWeekly">Weekly factor: monthlyFactor^(1/(52/12))</li>
              <li data-i18n="calculator.mathYearly">Yearly factor (CAGR): totalFactor^(12/months)</li>
            </ul>
          </div>
        </details>
      </div>
    </div>
  </div>
</section>

<script>
  // Calculator Logic
  document.addEventListener('DOMContentLoaded', () => {
    const SNAPSHOT_GAIN_PCT = 264.40;
    const SNAPSHOT_MAX_DD_PCT = 5.46;

    const els = {
      principal: document.getElementById('calcPrincipal') as HTMLInputElement,
      monthsRange: document.getElementById('calcMonthsRange') as HTMLInputElement,
      monthsVal: document.getElementById('calcMonthsVal')!,
      wkRoi: document.getElementById('calcWkRoi')!,
      moRoi: document.getElementById('calcMoRoi')!,
      yrRoi: document.getElementById('calcYrRoi')!,
      wkProfit: document.getElementById('calcWkProfit')!,
      moProfit: document.getElementById('calcMoProfit')!,
      yrProfit: document.getElementById('calcYrProfit')!,
      fullEnd: document.getElementById('calcFullEnd')!,
      fullProfit: document.getElementById('calcFullProfit')!,
      ddAmt: document.getElementById('calcDdAmt')!,
      curToggle: document.getElementById('calcCurToggle')!,
      curLabel: document.getElementById('calcCurLabel')!,
      saveBtn: document.getElementById('calcSaveBtn')!,
      resetBtn: document.getElementById('calcResetBtn')!,
    };

    let currency = 'EUR';

    const symbol = () => currency === 'USD' ? '$' : '€';

    const fmtMoney = (n: number) => {
      n = isFinite(n) ? n : 0;
      return symbol() + new Intl.NumberFormat(undefined, { 
        maximumFractionDigits: 2, 
        minimumFractionDigits: 2 
      }).format(n);
    };

    const fmtPct = (n: number) => (isFinite(n) ? (n * 100) : 0).toFixed(2) + '%';

    // Get translations for profit/end labels
    const getLang = () => document.documentElement.getAttribute('data-lang') || 'en';
    const profitLabel = () => getLang() === 'es' ? 'Beneficio' : 'Profit';
    const endLabel = () => getLang() === 'es' ? 'Final' : 'End';

    function recalc() {
      const P = Math.max(0, parseFloat(els.principal.value || '0'));
      const months = Math.max(1, parseFloat(els.monthsRange.value || '1'));

      els.monthsVal.textContent = String(months);

      const totalFactor = 1 + (SNAPSHOT_GAIN_PCT / 100);
      const monthlyFactor = Math.pow(totalFactor, 1 / months);
      const monthlyR = monthlyFactor - 1;

      const weeksPerMonth = 52 / 12;
      const weeklyFactor = Math.pow(monthlyFactor, 1 / weeksPerMonth);
      const weeklyR = weeklyFactor - 1;

      const yearlyFactor = Math.pow(totalFactor, 12 / months);
      const yearlyR = yearlyFactor - 1;

      const endWeek = P * weeklyFactor;
      const endMonth = P * monthlyFactor;
      const endYear = P * yearlyFactor;
      const endFull = P * totalFactor;
      const ddAmt = endFull * (SNAPSHOT_MAX_DD_PCT / 100);

      els.wkRoi.textContent = fmtPct(weeklyR);
      els.moRoi.textContent = fmtPct(monthlyR);
      els.yrRoi.textContent = fmtPct(yearlyR);

      els.wkProfit.textContent = `${profitLabel()}: ${fmtMoney(endWeek - P)} • ${endLabel()}: ${fmtMoney(endWeek)}`;
      els.moProfit.textContent = `${profitLabel()}: ${fmtMoney(endMonth - P)} • ${endLabel()}: ${fmtMoney(endMonth)}`;
      els.yrProfit.textContent = `${profitLabel()}: ${fmtMoney(endYear - P)} • ${endLabel()}: ${fmtMoney(endYear)}`;

      els.fullEnd.textContent = fmtMoney(endFull);
      els.fullProfit.textContent = `(${profitLabel().toLowerCase()} ${fmtMoney(endFull - P)})`;
      els.ddAmt.textContent = fmtMoney(ddAmt);
      els.curLabel.textContent = currency;
    }

    function toggleCurrency() {
      currency = currency === 'EUR' ? 'USD' : 'EUR';
      els.curToggle.dataset.currency = currency;
      recalc();
    }

    function save() {
      localStorage.setItem('duplifinance-calc', JSON.stringify({
        principal: els.principal.value || '1000',
        months: els.monthsRange.value || '6',
        currency
      }));
      const saveText = els.saveBtn.querySelector('span')!;
      const originalText = saveText.textContent;
      saveText.textContent = '✓';
      setTimeout(() => saveText.textContent = originalText, 900);
    }

    function load() {
      const raw = localStorage.getItem('duplifinance-calc');
      if (!raw) return false;
      try {
        const d = JSON.parse(raw);
        if (d.principal) els.principal.value = d.principal;
        if (d.months) els.monthsRange.value = d.months;
        if (d.currency === 'USD' || d.currency === 'EUR') currency = d.currency;
        els.curToggle.dataset.currency = currency;
        return true;
      } catch { return false; }
    }

    function reset() {
      els.principal.value = '1000';
      els.monthsRange.value = '6';
      currency = 'EUR';
      els.curToggle.dataset.currency = currency;
      localStorage.removeItem('duplifinance-calc');
      recalc();
    }

    // Events
    els.principal.addEventListener('input', recalc);
    els.monthsRange.addEventListener('input', recalc);
    els.curToggle.addEventListener('click', toggleCurrency);
    els.saveBtn.addEventListener('click', save);
    els.resetBtn.addEventListener('click', reset);

    // Init
    if (!load()) reset();
    recalc();
  });
</script>

<style>
  .calculator-section {
    padding: 60px 0;
  }

  .calc-card {
    background: var(--card);
    border: 1px solid var(--stroke);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow);
    overflow: hidden;
    backdrop-filter: blur(12px);
  }

  .calc-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--stroke);
    background: rgba(196, 233, 174, 0.04);
  }

  .calc-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .calc-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: var(--card2);
    border: 1px solid var(--stroke);
    border-radius: 100px;
    font-size: 13px;
  }

  .pill-label {
    color: var(--muted);
    font-weight: 500;
  }

  .pill-value {
    color: var(--text);
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }

  .calc-body {
    padding: 24px;
  }

  .calc-controls {
    display: grid;
    grid-template-columns: 1fr 1.3fr;
    gap: 18px;
    margin-bottom: 24px;
  }

  @media (max-width: 768px) {
    .calc-controls {
      grid-template-columns: 1fr;
    }
  }

  .calc-panel {
    padding: 18px;
    background: var(--card2);
    border: 1px solid var(--stroke);
    border-radius: var(--radius-lg);
  }

  .calc-panel label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .calc-panel input[type="number"] {
    width: 100%;
    padding: 14px 16px;
    background: var(--bg);
    border: 1px solid var(--stroke2);
    border-radius: var(--radius-md);
    color: var(--text);
    font-size: 16px;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .calc-panel input[type="number"]:focus {
    border-color: var(--brand);
    box-shadow: var(--focus);
  }

  .calc-panel input[type="range"] {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: var(--stroke);
    appearance: none;
    cursor: pointer;
  }

  .calc-panel input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 22px;
    height: 22px;
    background: linear-gradient(135deg, var(--brand), var(--brand2));
    border-radius: 50%;
    border: 3px solid var(--bg);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    cursor: grab;
  }

  .calc-panel input[type="range"]::-webkit-slider-thumb:active {
    cursor: grabbing;
  }

  .calc-helper {
    margin-top: 10px;
    font-size: 12px;
    color: var(--muted2);
    line-height: 1.4;
  }

  .calc-range-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .calc-label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 500;
  }

  .calc-value {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
    font-variant-numeric: tabular-nums;
  }

  .calc-currency-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 18px;
    padding-top: 18px;
    border-top: 1px solid var(--stroke);
  }

  .calc-toggle {
    position: relative;
    width: 100px;
    height: 38px;
    padding: 4px;
    background: var(--bg);
    border: 1px solid var(--stroke2);
    border-radius: 100px;
    cursor: pointer;
    overflow: hidden;
  }

  .toggle-knob {
    position: absolute;
    top: 4px;
    left: 4px;
    width: 46px;
    height: 30px;
    background: linear-gradient(135deg, var(--brand), var(--brand2));
    border-radius: 100px;
    transition: transform 0.2s ease;
  }

  .calc-toggle[data-currency="USD"] .toggle-knob {
    transform: translateX(46px);
  }

  .toggle-labels {
    position: relative;
    z-index: 1;
    display: flex;
    justify-content: space-between;
    width: 100%;
    padding: 0 12px;
    font-size: 12px;
    font-weight: 700;
    line-height: 30px;
  }

  .toggle-labels span {
    color: var(--muted);
    transition: color 0.2s;
  }

  .calc-toggle[data-currency="EUR"] .toggle-labels span:first-child,
  .calc-toggle[data-currency="USD"] .toggle-labels span:last-child {
    color: var(--bg);
  }

  .calc-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
    margin-bottom: 20px;
  }

  @media (max-width: 768px) {
    .calc-stats {
      grid-template-columns: 1fr;
    }
  }

  .calc-stat {
    padding: 18px;
    background: var(--card2);
    border: 1px solid var(--stroke);
    border-radius: var(--radius-lg);
    text-align: center;
  }

  .calc-stat.highlight {
    background: linear-gradient(135deg, rgba(196, 233, 174, 0.12), rgba(196, 233, 174, 0.04));
    border-color: rgba(196, 233, 174, 0.25);
  }

  .stat-value {
    font-size: 26px;
    font-weight: 800;
    color: var(--brand);
    font-variant-numeric: tabular-nums;
    letter-spacing: -0.5px;
  }

  .stat-label {
    margin-top: 6px;
    font-size: 11px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-detail {
    margin-top: 10px;
    font-size: 12px;
    color: var(--muted2);
    font-variant-numeric: tabular-nums;
  }

  .calc-summary {
    display: flex;
    justify-content: space-between;
    gap: 14px;
    padding: 16px 18px;
    background: var(--card2);
    border: 1px solid var(--stroke);
    border-radius: var(--radius-md);
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .summary-item {
    flex: 1;
    min-width: 200px;
  }

  .summary-value {
    margin-top: 6px;
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    font-variant-numeric: tabular-nums;
  }

  .summary-sub {
    margin-left: 6px;
    font-size: 13px;
    font-weight: 500;
    color: var(--muted);
  }

  .calc-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .calc-actions .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .calc-actions .btn-primary {
    background: linear-gradient(135deg, var(--brand), var(--brand2));
    color: var(--bg);
    border: none;
  }

  .calc-actions .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(30, 56, 58, 0.25);
  }

  .calc-actions .btn-outline {
    background: transparent;
    color: var(--text);
    border: 1px solid var(--stroke2);
  }

  .calc-actions .btn-outline:hover {
    background: var(--card2);
    border-color: var(--stroke);
  }

  .calc-disclaimer {
    display: flex;
    gap: 12px;
    padding: 14px 16px;
    background: rgba(201, 162, 39, 0.08);
    border: 1px solid rgba(201, 162, 39, 0.20);
    border-radius: var(--radius-md);
    margin-bottom: 16px;
  }

  .calc-disclaimer i {
    flex-shrink: 0;
    color: #c9a227;
  }

  .calc-disclaimer p {
    margin: 0;
    font-size: 12.5px;
    line-height: 1.5;
    color: var(--muted);
  }

  .calc-details {
    background: var(--card2);
    border: 1px solid var(--stroke);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .calc-details summary {
    padding: 14px 18px;
    font-size: 14px;
    font-weight: 600;
    color: var(--muted);
    cursor: pointer;
    transition: background 0.15s;
  }

  .calc-details summary:hover {
    background: var(--bg);
  }

  .calc-details[open] summary {
    border-bottom: 1px solid var(--stroke);
  }

  .details-content {
    padding: 16px 18px;
    font-size: 13px;
    color: var(--muted2);
    line-height: 1.5;
  }

  .details-content p {
    margin: 0 0 12px;
  }

  .details-content ul {
    margin: 0;
    padding-left: 20px;
  }

  .details-content li {
    margin-bottom: 6px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    font-size: 12px;
  }

  /* Dark mode adjustments */
  [data-theme="dark"] .calc-toggle[data-currency="EUR"] .toggle-labels span:first-child,
  [data-theme="dark"] .calc-toggle[data-currency="USD"] .toggle-labels span:last-child {
    color: var(--text);
  }

  [data-theme="dark"] .calc-actions .btn-primary {
    color: #0b1415;
  }
</style>
