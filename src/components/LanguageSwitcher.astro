---
// Language Switcher Component
---

<div class="lang-switcher">
  <button id="lang-en" class="lang-btn" data-lang="en" title="English">EN</button>
  <span class="lang-divider">/</span>
  <button id="lang-es" class="lang-btn" data-lang="es" title="EspaÃ±ol">ES</button>
</div>

<style>
  .lang-switcher {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-right: 8px;
  }

  .lang-btn {
    background: transparent;
    border: none;
    padding: 4px 8px;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-family: inherit;
    letter-spacing: 0.05em;
  }

  .lang-btn:hover {
    color: var(--text-primary);
    background: var(--surface-hover);
  }

  .lang-btn.active {
    color: var(--accent-primary);
    font-weight: 600;
  }

  .lang-divider {
    color: var(--text-tertiary);
    font-size: 0.75rem;
    user-select: none;
  }

  @media (max-width: 768px) {
    .lang-switcher {
      margin-right: 4px;
    }
  }
</style>

<script>
  const STORAGE_KEY = 'duplifinance-lang';
  
  function initLanguageSwitcher() {
    const enBtn = document.getElementById('lang-en');
    const esBtn = document.getElementById('lang-es');
    
    function updateActiveState(lang: string) {
      if (enBtn && esBtn) {
        enBtn.classList.toggle('active', lang === 'en');
        esBtn.classList.toggle('active', lang === 'es');
      }
    }
    
    // Get current language from storage (priority) or detect from browser
    const storedLang = localStorage.getItem(STORAGE_KEY);
    let currentLang: string;
    
    if (storedLang && (storedLang === 'en' || storedLang === 'es')) {
      // User has explicitly chosen a language - use it
      currentLang = storedLang;
    } else {
      // No stored preference - detect from browser
      const browserLang = navigator.language.toLowerCase();
      currentLang = browserLang.startsWith('es') ? 'es' : 'en';
      localStorage.setItem(STORAGE_KEY, currentLang);
    }
    
    document.documentElement.setAttribute('data-lang', currentLang);
    document.documentElement.setAttribute('lang', currentLang);
    updateActiveState(currentLang);
    
    // Apply translations on initial load if not default (in case Layout script ran before translations were ready)
    updateTranslations(currentLang);
    
    // Handle clicks
    enBtn?.addEventListener('click', () => {
      localStorage.setItem(STORAGE_KEY, 'en');
      document.documentElement.setAttribute('data-lang', 'en');
      updateActiveState('en');
      window.dispatchEvent(new CustomEvent('language-change', { detail: 'en' }));
      updateTranslations('en');
    });
    
    esBtn?.addEventListener('click', () => {
      localStorage.setItem(STORAGE_KEY, 'es');
      document.documentElement.setAttribute('data-lang', 'es');
      updateActiveState('es');
      window.dispatchEvent(new CustomEvent('language-change', { detail: 'es' }));
      updateTranslations('es');
    });
  }
  
  // Translation data embedded in component
  function updateTranslations(lang: string) {
    // Update all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach((el) => {
      const key = el.getAttribute('data-i18n');
      if (key) {
        const [section, field] = key.split('.');
        const translation = getTranslation(lang, section, field);
        if (translation) {
          el.textContent = translation;
        }
      }
    });
    
    // Update elements with data-i18n-placeholder
    document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
      const key = el.getAttribute('data-i18n-placeholder');
      if (key) {
        const [section, field] = key.split('.');
        const translation = getTranslation(lang, section, field);
        if (translation && el instanceof HTMLInputElement) {
          el.placeholder = translation;
        }
      }
    });
    
    // Update elements with data-i18n-title
    document.querySelectorAll('[data-i18n-title]').forEach((el) => {
      const key = el.getAttribute('data-i18n-title');
      if (key) {
        const [section, field] = key.split('.');
        const translation = getTranslation(lang, section, field);
        if (translation) {
          el.setAttribute('title', translation);
        }
      }
    });
    
    // Update elements with data-i18n-aria-label
    document.querySelectorAll('[data-i18n-aria-label]').forEach((el) => {
      const key = el.getAttribute('data-i18n-aria-label');
      if (key) {
        const [section, field] = key.split('.');
        const translation = getTranslation(lang, section, field);
        if (translation) {
          el.setAttribute('aria-label', translation);
        }
      }
    });

    // Update elements with data-i18n-img (for language-specific images)
    document.querySelectorAll('[data-i18n-img]').forEach((el) => {
      const key = el.getAttribute('data-i18n-img');
      if (key) {
        const [section, field] = key.split('.');
        const translation = getTranslation(lang, section, field);
        if (translation && el instanceof HTMLImageElement) {
          el.src = translation;
        }
      }
    });
  }
  
  function getTranslation(lang: string, section: string, field: string): string | null {
    // @ts-ignore - translations object injected below
    const data = window.__TRANSLATIONS__;
    if (data && data[lang] && data[lang][section] && data[lang][section][field]) {
      let text = data[lang][section][field];
      // Handle dynamic values like {year}
      if (text.includes('{year}')) {
        text = text.replace('{year}', new Date().getFullYear().toString());
      }
      return text;
    }
    return null;
  }
  
  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLanguageSwitcher);
  } else {
    initLanguageSwitcher();
  }
  
  // Re-initialize on page navigation (for view transitions)
  document.addEventListener('astro:page-load', initLanguageSwitcher);
</script>
